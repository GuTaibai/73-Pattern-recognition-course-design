
# YOLOv5

Implement anchor generation ([autoanchor.py](https://github.com/ultralytics/yolov5/blob/915bbf294bb74c859f0b41f1c23bc395014ea679/utils/autoanchor.py)) using YOLOv5 v7.0 version, generating a list of 1 to 10 anchor points.

By comparing the average IOU of all truth annotated boxes generated by v5 version, it can be found that the implementation is similar to v2/v3 on the VOC dataset, but there is a significant improvement on the COCO dataset.

## Pascal VOC

### Prepare data

See [voc2yolov5.py](https://github.com/zjykzj/vocdev/blob/master/py/voc2yolov5.py) to get the train/test dataset

```shell
python py/voc2yolov5.py -s ../datasets/voc -d ../datasets/voc2yolov5-train -l trainval-2007 trainval-2012
python py/voc2yolov5.py -s ../datasets/voc -d ../datasets/voc2yolov5-val -l test-2007
```

### Generate anchor-boxes

Generate a specified number of anchor-boxes lists

```
python gen_anchors.py -t voc2yolov5-train -v voc2yolov5-val -n 5 -e voc /home/zj/data/voc ./generated_anchors
```

Or traverse anchor-boxes with different numbers [1, 10]. See [generated_anchors/voc](generated_anchors/voc)

```
$ python3 v5/gen_anchors.py ../datasets/ ./output/
args: Namespace(data='../datasets/', exp='voc', num_clusters=None, output='./output/', train='voc2yolov5-train', val='voc2yolov5-val')
100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 16551/16551 [04:55<00:00, 56.07it/s]
100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 4952/4952 [01:19<00:00, 62.07it/s]
AutoAnchor: Running kmeans for 1 anchors on 40058 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.4228: 100%|██████████| 1000/1000 00:00
AutoAnchor: thr=0.25: 0.8636 best possible recall, 0.86 anchors past thr
AutoAnchor: n=1, img_size=640, metric_all=0.446/0.446-mean/best, past_thr=0.490-mean: 164,194
Train Avg IOU: 0.3303571029850243
Test Avg IOU: 0.3417355726483308
Write to ./output/voc/anchors1.txt

AutoAnchor: Running kmeans for 2 anchors on 40058 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.5683: 100%|██████████| 1000/1000 00:01
AutoAnchor: thr=0.25: 0.9780 best possible recall, 1.37 anchors past thr
AutoAnchor: n=2, img_size=640, metric_all=0.401/0.573-mean/best, past_thr=0.511-mean: 72,102, 301,299
Train Avg IOU: 0.47692001124021316
Test Avg IOU: 0.48709204209112883
Write to ./output/voc/anchors2.txt

AutoAnchor: Running kmeans for 3 anchors on 40058 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.6327: 100%|██████████| 1000/1000 00:02
AutoAnchor: thr=0.25: 0.9923 best possible recall, 2.00 anchors past thr
AutoAnchor: n=3, img_size=640, metric_all=0.391/0.634-mean/best, past_thr=0.507-mean: 56,76, 146,206, 399,341
Train Avg IOU: 0.5518383123199105
Test Avg IOU: 0.5606169952431606
Write to ./output/voc/anchors3.txt

AutoAnchor: Running kmeans for 4 anchors on 40058 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.6684: 100%|██████████| 1000/1000 00:03
AutoAnchor: thr=0.25: 0.9959 best possible recall, 2.65 anchors past thr
AutoAnchor: n=4, img_size=640, metric_all=0.387/0.669-mean/best, past_thr=0.505-mean: 49,64, 105,143, 197,269, 451,356
Train Avg IOU: 0.5929831428526345
Test Avg IOU: 0.6016318778946959
Write to ./output/voc/anchors4.txt

AutoAnchor: Running kmeans for 5 anchors on 40058 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.6915: 100%|██████████| 1000/1000 00:03
AutoAnchor: thr=0.25: 0.9980 best possible recall, 3.35 anchors past thr
AutoAnchor: n=5, img_size=640, metric_all=0.383/0.692-mean/best, past_thr=0.496-mean: 46,55, 74,129, 163,159, 210,312, 464,358
Train Avg IOU: 0.6164375497174446
Test Avg IOU: 0.6248260737050318
Write to ./output/voc/anchors5.txt

AutoAnchor: Running kmeans for 6 anchors on 40058 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.7096: 100%|██████████| 1000/1000 00:03
AutoAnchor: thr=0.25: 0.9974 best possible recall, 4.00 anchors past thr
AutoAnchor: n=6, img_size=640, metric_all=0.383/0.710-mean/best, past_thr=0.497-mean: 42,59, 84,100, 122,210, 270,172, 228,344, 475,376
Train Avg IOU: 0.6367144076932566
Test Avg IOU: 0.6444809111942006
Write to ./output/voc/anchors6.txt

AutoAnchor: Running kmeans for 7 anchors on 40058 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.7244: 100%|██████████| 1000/1000 00:04
AutoAnchor: thr=0.25: 0.9983 best possible recall, 4.62 anchors past thr
AutoAnchor: n=7, img_size=640, metric_all=0.378/0.725-mean/best, past_thr=0.494-mean: 44,51, 68,113, 155,130, 121,250, 238,323, 408,213, 481,404
Train Avg IOU: 0.6524972397978773
Test Avg IOU: 0.6608975981806872
Write to ./output/voc/anchors7.txt

AutoAnchor: Running kmeans for 8 anchors on 40058 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.7387: 100%|██████████| 1000/1000 00:04
AutoAnchor: thr=0.25: 0.9987 best possible recall, 5.28 anchors past thr
AutoAnchor: n=8, img_size=640, metric_all=0.376/0.739-mean/best, past_thr=0.491-mean: 37,51, 68,86, 84,182, 160,129, 170,275, 379,199, 290,368, 522,399
Train Avg IOU: 0.6690814735026006
Test Avg IOU: 0.6756102132870858
Write to ./output/voc/anchors8.txt

AutoAnchor: Running kmeans for 9 anchors on 40058 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.7479: 100%|██████████| 1000/1000 00:06
AutoAnchor: thr=0.25: 0.9987 best possible recall, 5.84 anchors past thr
AutoAnchor: n=9, img_size=640, metric_all=0.373/0.748-mean/best, past_thr=0.493-mean: 34,56, 75,71, 81,164, 173,138, 141,286, 250,253, 503,213, 294,427, 527,406
Train Avg IOU: 0.6779821925072332
Test Avg IOU: 0.68351958723183
Write to ./output/voc/anchors9.txt

AutoAnchor: Running kmeans for 10 anchors on 40058 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.7603: 100%|██████████| 1000/1000 00:06
AutoAnchor: thr=0.25: 0.9989 best possible recall, 6.36 anchors past thr
AutoAnchor: n=10, img_size=640, metric_all=0.369/0.761-mean/best, past_thr=0.494-mean: 32,49, 82,65, 52,128, 108,163, 216,149, 149,296, 251,312, 468,232, 339,449, 543,404
Train Avg IOU: 0.6922661850653943
Test Avg IOU: 0.6982938734091167 
Write to ./output/voc/anchors10.txt
```

## COCO

### Prepare data

See [coco2yolov5.py](https://github.com/zjykzj/cocodev/blob/master/py/coco2yolov5.py) to get the train/test dataset

```shell
python coco2yolov5.py ../datasets/coco ../datasets/coco2yolov5-train --name train2017
python coco2yolov5.py ../datasets/coco ../datasets/coco2yolov5-val --name val2017
```

### Generate anchor-boxes

Generate a specified number of anchor-boxes lists

```
python3 v5/gen_anchors.py ../datasets/coco/ -t train2017 -v val2017 ./output/ -e coco -n 5
```

Or traverse anchor-boxes with different numbers [1, 10]. See [generated_anchors/coco](generated_anchors/coco)

```
$ python3 v5/gen_anchors.py ../datasets/coco/ -t train2017 -v val2017 ./output/ -e coco
args: Namespace(data='../datasets/coco/', exp='coco', num_clusters=None, output='./output/', train='train2017', val='val2017')
100%|███████████████████████████████████████████████████████████████████████████████████████| 117266/117266 [43:42<00:00, 44.71it/s]100%|███████████████████████████████████████████████████████████████████████████████████████████| 4952/4952 [01:12<00:00, 68.35it/s]AutoAnchor: WARNING ⚠️ Extremely small objects found: 3884 of 849947 labels are <3 pixels in size
AutoAnchor: Running kmeans for 1 anchors on 849903 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.3071: 100%|██████████| 1000/1000 00:02
AutoAnchor: thr=0.25: 0.6410 best possible recall, 0.64 anchors past thr
AutoAnchor: n=1, img_size=640, metric_all=0.365/0.365-mean/best, past_thr=0.479-mean: 52,63
Train Avg IOU: 0.25585608963010986
Test Avg IOU: 0.2576263584740824
Write to ./output/coco/anchors1.txt

AutoAnchor: WARNING ⚠️ Extremely small objects found: 3884 of 849947 labels are <3 pixels in size
AutoAnchor: Running kmeans for 2 anchors on 849903 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.4725: 100%|██████████| 1000/1000 00:06
AutoAnchor: thr=0.25: 0.9264 best possible recall, 1.10 anchors past thr
AutoAnchor: n=2, img_size=640, metric_all=0.322/0.486-mean/best, past_thr=0.478-mean: 27,35, 160,160
Train Avg IOU: 0.3828875314188507
Test Avg IOU: 0.3855426610058954
Write to ./output/coco/anchors2.txt

AutoAnchor: WARNING ⚠️ Extremely small objects found: 3884 of 849947 labels are <3 pixels in size
AutoAnchor: Running kmeans for 3 anchors on 849903 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.5466: 100%|██████████| 1000/1000 00:08
AutoAnchor: thr=0.25: 0.9719 best possible recall, 1.60 anchors past thr
AutoAnchor: n=3, img_size=640, metric_all=0.316/0.552-mean/best, past_thr=0.479-mean: 18,23, 55,64, 176,192
Train Avg IOU: 0.4619212150106412
Test Avg IOU: 0.46317908661238666
Write to ./output/coco/anchors3.txt

AutoAnchor: WARNING ⚠️ Extremely small objects found: 3884 of 849947 labels are <3 pixels in size
AutoAnchor: Running kmeans for 4 anchors on 849903 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.5887: 100%|██████████| 1000/1000 00:12
AutoAnchor: thr=0.25: 0.9822 best possible recall, 2.05 anchors past thr
AutoAnchor: n=4, img_size=640, metric_all=0.308/0.592-mean/best, past_thr=0.479-mean: 14,19, 39,43, 85,106, 238,241
Train Avg IOU: 0.5088584844755929
Test Avg IOU: 0.5115466688443204
Write to ./output/coco/anchors4.txt

AutoAnchor: WARNING ⚠️ Extremely small objects found: 3884 of 849947 labels are <3 pixels in size
AutoAnchor: Running kmeans for 5 anchors on 849903 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.6173: 100%|██████████| 1000/1000 00:23
AutoAnchor: thr=0.25: 0.9888 best possible recall, 2.50 anchors past thr
AutoAnchor: n=5, img_size=640, metric_all=0.302/0.620-mean/best, past_thr=0.479-mean: 12,15, 26,35, 59,61, 106,140, 280,276
Train Avg IOU: 0.5396773630203726
Test Avg IOU: 0.5418924431732244
Write to ./output/coco/anchors5.txt

AutoAnchor: WARNING ⚠️ Extremely small objects found: 3884 of 849947 labels are <3 pixels in size
AutoAnchor: Running kmeans for 6 anchors on 849903 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.6395: 100%|██████████| 1000/1000 00:28
AutoAnchor: thr=0.25: 0.9913 best possible recall, 2.96 anchors past thr
AutoAnchor: n=6, img_size=640, metric_all=0.298/0.641-mean/best, past_thr=0.475-mean: 11,15, 27,25, 34,62, 85,71, 114,174, 307,283
Train Avg IOU: 0.5587093844852696
Test Avg IOU: 0.5593599423814017
Write to ./output/coco/anchors6.txt

AutoAnchor: WARNING ⚠️ Extremely small objects found: 3884 of 849947 labels are <3 pixels in size
AutoAnchor: Running kmeans for 7 anchors on 849903 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.6589: 100%|██████████| 1000/1000 00:32
AutoAnchor: thr=0.25: 0.9926 best possible recall, 3.45 anchors past thr
AutoAnchor: n=7, img_size=640, metric_all=0.297/0.660-mean/best, past_thr=0.472-mean: 12,13, 18,32, 47,34, 40,83, 99,79, 127,187, 325,299
Train Avg IOU: 0.578386445207848
Test Avg IOU: 0.5791797260006512
Write to ./output/coco/anchors7.txt

AutoAnchor: WARNING ⚠️ Extremely small objects found: 3884 of 849947 labels are <3 pixels in size
AutoAnchor: Running kmeans for 8 anchors on 849903 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.6746: 100%|██████████| 1000/1000 00:37
AutoAnchor: thr=0.25: 0.9924 best possible recall, 3.90 anchors past thr
AutoAnchor: n=8, img_size=640, metric_all=0.293/0.676-mean/best, past_thr=0.470-mean: 11,16, 29,22, 23,52, 59,49, 58,119, 136,99, 158,235, 399,315
Train Avg IOU: 0.5940073073064387
Test Avg IOU: 0.5954926148466513
Write to ./output/coco/anchors8.txt

AutoAnchor: WARNING ⚠️ Extremely small objects found: 3884 of 849947 labels are <3 pixels in size
AutoAnchor: Running kmeans for 9 anchors on 849903 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.6886: 100%|██████████| 1000/1000 00:41
AutoAnchor: thr=0.25: 0.9952 best possible recall, 4.30 anchors past thr
AutoAnchor: n=9, img_size=640, metric_all=0.288/0.690-mean/best, past_thr=0.469-mean: 11,12, 15,34, 35,23, 36,58, 86,55, 64,135, 144,120, 179,251, 430,340
Train Avg IOU: 0.6098931133076843
Test Avg IOU: 0.6107376111324904
Write to ./output/coco/anchors9.txt

AutoAnchor: WARNING ⚠️ Extremely small objects found: 3884 of 849947 labels are <3 pixels in size
AutoAnchor: Running kmeans for 10 anchors on 849903 points...
AutoAnchor: Evolving anchors with Genetic Algorithm: fitness = 0.7001: 100%|██████████| 1000/1000 00:44
AutoAnchor: thr=0.25: 0.9949 best possible recall, 4.78 anchors past thr
AutoAnchor: n=10, img_size=640, metric_all=0.288/0.701-mean/best, past_thr=0.469-mean: 9,14, 24,18, 18,42, 46,34, 41,78, 93,73, 78,165, 178,136, 188,291, 425,344
Train Avg IOU: 0.6234657294773692
Test Avg IOU: 0.6242110968229861
Write to ./output/coco/anchors10.txt
```